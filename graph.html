<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª - ã‚°ãƒ©ãƒ•</title>
  <link rel="stylesheet" href="style.css"> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
    /* ã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    /* .graph-section ã¯ style.css ã«ç§»å‹• */

    /* .filter-tabs ã¯ style.css ã«ç§»å‹• */
    /* .filter-tab ã¯ style.css ã«ç§»å‹• */

    .period-selector {
        margin-bottom: 20px;
    }

    .period-selector select {
        width: calc(100% - 20px); /* å·¦å³ã®ä½™ç™½ã‚’è€ƒæ…® */
        max-width: 300px;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        background-color: white;
    }

    .chart-container, .bar-chart-container {
      position: relative;
      width: 100%;
      max-width: 500px; /* ãƒ‰ãƒ¼ãƒŠãƒ„ãƒãƒ£ãƒ¼ãƒˆã®æœ€å¤§å¹… */
      height: 350px; /* ãƒ‰ãƒ¼ãƒŠãƒ„ãƒãƒ£ãƒ¼ãƒˆã®é«˜ã• */
      margin: 20px auto;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .bar-chart-container {
      max-width: 700px; /* æ£’ã‚°ãƒ©ãƒ•ã®æœ€å¤§å¹… */
      height: 400px; /* æ£’ã‚°ãƒ©ãƒ•ã®é«˜ã• */
    }

    .summary-box {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-top: 20px;
        text-align: left;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-weight: 600;
        color: #555;
    }

    .summary-value {
        font-weight: 700;
        font-size: 18px;
    }

    .summary-value.income { color: #4CAF50; }
    .summary-value.expense { color: #FF5722; }
    .summary-value.balance {
        color: #3498db; /* é’ */
        font-size: 20px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
        .chart-container, .bar-chart-container {
            height: 300px; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®é«˜ã•ã‚’èª¿æ•´ */
            padding: 10px;
        }
    }
    @media (max-width: 480px) {
        .chart-container, .bar-chart-container {
            height: 250px; /* ã•ã‚‰ã«å°ã•ãªã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®é«˜ã•ã‚’èª¿æ•´ */
        }
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ã‚°ãƒ©ãƒ•</h1>
      <p>åæ”¯ã®å‚¾å‘ã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèªã—ã¾ã—ã‚‡ã†</p>
      <div class="nav-links">
        <a href="index.html" class="nav-link">ğŸ  ãƒ›ãƒ¼ãƒ </a>
        <a href="calendar.html" class="nav-link">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
        <a href="category_manager.html" class="nav-link">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</a>
        <a href="pachinko_index.html" class="nav-link">ğŸ° ãƒ‘ãƒã‚¹ãƒ­åæ”¯</a>
      </div>
    </div>

    <div class="content">
      <div class="graph-section">
        <h2>ğŸ—“ï¸ è¡¨ç¤ºæœŸé–“</h2>
        <div class="period-selector">
            <select id="month-selector"></select>
        </div>
      </div>

      <div class="graph-section">
        <h2>ğŸ’° æœˆé–“ã‚µãƒãƒªãƒ¼</h2>
        <div class="summary-box">
            <div class="summary-item">
                <span class="summary-label">åå…¥åˆè¨ˆ:</span>
                <span class="summary-value income" id="total-income">0å††</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">æ”¯å‡ºåˆè¨ˆ:</span>
                <span class="summary-value expense" id="total-expense">0å††</span>
            </div>
            <div class="summary-item" style="border-top: 2px solid #eee; margin-top: 10px; padding-top: 10px;">
                <span class="summary-label">å·®å¼•æ®‹é«˜:</span>
                <span class="summary-value balance" id="balance">0å††</span>
            </div>
        </div>
      </div>

      <div class="graph-section">
        <h2>ğŸ“‰ æ”¯å‡ºå†…è¨³</h2>
        <div class="chart-container">
          <canvas id="expenseDoughnutChart"></canvas>
        </div>
      </div>

      <div class="graph-section">
        <h2>ğŸ“ˆ åå…¥å†…è¨³</h2>
        <div class="chart-container">
          <canvas id="incomeDoughnutChart"></canvas>
        </div>
      </div>

      <div class="graph-section">
        <h2>ğŸ“Š éå»6ãƒ¶æœˆã®åæ”¯æ¨ç§»</h2>
        <div class="bar-chart-container">
            <canvas id="monthlyBalanceBarChart"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script>
    const STORAGE_KEY = 'household_account_book_transactions';
    const CATEGORY_STORAGE_KEY = 'household_account_book_categories';
    let expenseDoughnutChart;
    let incomeDoughnutChart;
    let monthlyBalanceBarChart;

    document.addEventListener('DOMContentLoaded', () => {
      populateMonthSelector();
      document.getElementById('month-selector').addEventListener('change', renderCharts);
      renderCharts(); // åˆå›æç”»
    });

    function getTransactions() {
      const transactionsJson = localStorage.getItem(STORAGE_KEY);
      return transactionsJson ? JSON.parse(transactionsJson) : [];
    }

    function getCategories() {
        const categoriesJson = localStorage.getItem(CATEGORY_STORAGE_KEY);
        return categoriesJson ? JSON.parse(categoriesJson) : { income: [], expense: [] };
    }

    function populateMonthSelector() {
        const selector = document.getElementById('month-selector');
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); // 0-indexed

        for (let i = 0; i < 12; i++) { // éå»1å¹´åˆ†ã®æœˆã‚’è¡¨ç¤º
            const date = new Date(currentYear, currentMonth - i, 1);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const value = `${year}-${String(month).padStart(2, '0')}`;
            const text = `${year}å¹´${month}æœˆ`;

            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            if (i === 0) { // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã‚’é¸æŠ
                option.selected = true;
            }
            selector.appendChild(option);
        }
    }

    function renderCharts() {
      const selectedMonth = document.getElementById('month-selector').value; // ä¾‹: "2023-11"
      const transactions = getTransactions();
      const categories = getCategories();

      // æœˆé–“ã‚µãƒãƒªãƒ¼ã¨ãƒ‰ãƒ¼ãƒŠãƒ„ãƒãƒ£ãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
      const filteredTransactions = transactions.filter(t => t.date.startsWith(selectedMonth));

      const totalIncome = filteredTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);

      const totalExpense = filteredTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);

      document.getElementById('total-income').textContent = `${totalIncome.toLocaleString()}å††`;
      document.getElementById('total-expense').textContent = `${totalExpense.toLocaleString()}å††`;
      const balance = totalIncome - totalExpense;
      document.getElementById('balance').textContent = `${balance.toLocaleString()}å††`;
      if (balance >= 0) {
        document.getElementById('balance').style.color = '#3498db'; // é’
      } else {
        document.getElementById('balance').style.color = '#e74c3c'; // èµ¤
      }


      // æ”¯å‡ºå†…è¨³ãƒ‡ãƒ¼ã‚¿
      const expenseCategoryMap = {};
      categories.expense.forEach(cat => expenseCategoryMap[cat.name] = 0); // å…¨ã‚«ãƒ†ã‚´ãƒªã‚’0ã§åˆæœŸåŒ–

      filteredTransactions.filter(t => t.type === 'expense').forEach(t => {
        if (expenseCategoryMap[t.mainCategory] !== undefined) {
          expenseCategoryMap[t.mainCategory] += parseFloat(t.amount);
        } else {
          // æœªå®šç¾©ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã€ãã®ä»–ã¨ã—ã¦é›†è¨ˆã™ã‚‹ã‹ã€æ–°è¦ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦è¿½åŠ  (ä»Šå›ã¯æ—¢å­˜ã‚«ãƒ†ã‚´ãƒªã®ã¿)
          // console.warn(`Undefined expense category: ${t.mainCategory}`);
        }
      });
      const expenseLabels = Object.keys(expenseCategoryMap);
      const expenseData = Object.values(expenseCategoryMap);

      // åå…¥å†…è¨³ãƒ‡ãƒ¼ã‚¿
      const incomeCategoryMap = {};
      categories.income.forEach(cat => incomeCategoryMap[cat.name] = 0); // å…¨ã‚«ãƒ†ã‚´ãƒªã‚’0ã§åˆæœŸåŒ–

      filteredTransactions.filter(t => t.type === 'income').forEach(t => {
        if (incomeCategoryMap[t.mainCategory] !== undefined) {
          incomeCategoryMap[t.mainCategory] += parseFloat(t.amount);
        } else {
          // console.warn(`Undefined income category: ${t.mainCategory}`);
        }
      });
      const incomeLabels = Object.keys(incomeCategoryMap);
      const incomeData = Object.values(incomeCategoryMap);

      // ã‚°ãƒ©ãƒ•æç”»
      drawDoughnutChart('expenseDoughnutChart', 'æ”¯å‡ºå†…è¨³', expenseLabels, expenseData, getCategoryColors(expenseLabels));
      drawDoughnutChart('incomeDoughnutChart', 'åå…¥å†…è¨³', incomeLabels, incomeData, getCategoryColors(incomeLabels, true));

      drawMonthlyBalanceBarChart();
    }

    function drawDoughnutChart(canvasId, title, labels, data, colors) {
      const ctx = document.getElementById(canvasId).getContext('2d');

      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
      if (canvasId === 'expenseDoughnutChart' && expenseDoughnutChart) {
        expenseDoughnutChart.destroy();
      } else if (canvasId === 'incomeDoughnutChart' && incomeDoughnutChart) {
        incomeDoughnutChart.destroy();
      }

      const chartConfig = {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                font: {
                  size: 14
                }
              }
            },
            title: {
              display: true,
              text: title,
              font: {
                size: 18,
                weight: 'bold'
              }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed !== null) {
                            label += new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(context.parsed);
                        }
                        return label;
                    }
                }
            }
          }
        }
      };

      if (canvasId === 'expenseDoughnutChart') {
        expenseDoughnutChart = new Chart(ctx, chartConfig);
      } else if (canvasId === 'incomeDoughnutChart') {
        incomeDoughnutChart = new Chart(ctx, chartConfig);
      }
    }

    function getCategoryColors(labels, isIncome = false) {
        // è‰²ã®ã‚»ãƒƒãƒˆ (ã‚«ãƒ†ã‚´ãƒªãŒå¤šã„å ´åˆã¯ã‚‚ã£ã¨å¢—ã‚„ã™)
        const expenseColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
            '#C9CBCE', '#F7464A', '#46BFBD', '#FDB45C', '#949FB1', '#ACD683', '#66CCFF'
        ];
        const incomeColors = [
            '#4CAF50', '#8BC34A', '#AED581', '#66BB6A', '#81C784', '#C8E6C9', '#A5D6A7'
        ];
        const colors = isIncome ? incomeColors : expenseColors;
        const assignedColors = [];
        labels.forEach((label, index) => {
            assignedColors.push(colors[index % colors.length]);
        });
        return assignedColors;
    }


    function drawMonthlyBalanceBarChart() {
        const ctx = document.getElementById('monthlyBalanceBarChart').getContext('2d');
        if (monthlyBalanceBarChart) {
            monthlyBalanceBarChart.destroy();
        }

        const transactions = getTransactions();
        const monthlyData = {}; // { "YYYY-MM": { income: 0, expense: 0 } }

        // éå»6ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        const today = new Date();
        const months = [];
        for (let i = 5; i >= 0; i--) { // éå»5ãƒ¶æœˆ + ä»Šæœˆ = 6ãƒ¶æœˆ
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const ym = `${year}-${month}`;
            months.push(ym);
            monthlyData[ym] = { income: 0, expense: 0 };
        }

        transactions.forEach(t => {
            const ym = t.date.substring(0, 7); // "YYYY-MM"
            if (monthlyData[ym]) {
                if (t.type === 'income') {
                    monthlyData[ym].income += parseFloat(t.amount);
                } else {
                    monthlyData[ym].expense += parseFloat(t.amount);
                }
            }
        });

        const labels = months.map(ym => ym.replace('-', 'å¹´') + 'æœˆ');
        const incomeDatasets = months.map(ym => monthlyData[ym].income);
        const expenseDatasets = months.map(ym => monthlyData[ym].expense);
        const balanceDatasets = months.map(ym => monthlyData[ym].income - monthlyData[ym].expense);

        monthlyBalanceBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'åå…¥',
                        data: incomeDatasets,
                        backgroundColor: '#8BC34A', // income color
                        stack: 'combined',
                        order: 1 // åå…¥ãŒä¸‹ã«æ¥ã‚‹ã‚ˆã†ã«
                    },
                    {
                        label: 'æ”¯å‡º',
                        data: expenseDatasets.map(val => -val), // æ”¯å‡ºã¯è² ã®å€¤ã§è¡¨ç¤º
                        backgroundColor: '#FF5722', // expense color
                        stack: 'combined',
                        order: 2 // æ”¯å‡ºãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«
                    },
                    {
                        type: 'line', // æ®‹é«˜ã¯ç·šã‚°ãƒ©ãƒ•ã§è¡¨ç¤º
                        label: 'æ®‹é«˜',
                        data: balanceDatasets,
                        borderColor: '#3498db', // balance color
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        fill: false,
                        tension: 0.3,
                        yAxisID: 'balance-y-axis', // åˆ¥ã®Yè»¸ã‚’ä½¿ç”¨
                        order: 0 // æœ€å‰é¢ã«è¡¨ç¤º
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'æœˆã”ã¨ã®åå…¥ãƒ»æ”¯å‡ºãƒ»æ®‹é«˜',
                        font: {
                            size: 18,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(Math.abs(context.parsed.y));
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                           autoSkip: true,
                           maxRotation: 0,
                           minRotation: 0,
                           font: {
                               size: 10
                           }
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'é‡‘é¡ (å††)'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                return new Intl.NumberFormat('ja-JP').format(Math.abs(value)); // è² ã®è¨˜å·ã‚’éè¡¨ç¤º
                            }
                        }
                    },
                    'balance-y-axis': { // æ®‹é«˜ç”¨ã®Yè»¸
                        position: 'right', // å³å´ã«è¡¨ç¤º
                        grid: {
                            drawOnChartArea: false // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã«ã¯ã‚°ãƒªãƒƒãƒ‰ç·šã‚’æç”»ã—ãªã„
                        },
                        title: {
                            display: true,
                            text: 'æ®‹é«˜ (å††)'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                return new Intl.NumberFormat('ja-JP').format(value);
                            }
                        }
                    }
                }
            }
        });
    }

  </script>
</body>
</html>